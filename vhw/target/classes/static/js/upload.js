function getFile(){
    $("#getF").click();
}
var filename="";
function clickF() {
    filename = $("#getF").val();
    var filenames = filename.split("\\");
    filename = filenames[filenames.length-1];
    $("#display").val(filename);

}

function uploadVulnerability() {

    var file = document.getElementById("getF").files[0]; // js 获取文件对象

    var formData = new FormData();

    formData.append("file", file);


    $.ajax({

        url: "/uploadVulnerability",
        type: 'POST',
        data: formData,
        cache: false,
        contentType: false,
        processData: false,
        enctype: "multipart/form-data",
        async: true,
        timeout: 6000000,

        success: function (result) {

            // alert(result);
            alert("上传成功")

        },

        error: function (request) {
            alert("上传文件失败 ");
            window.location.reload();
        },

        xhr: function () {
            myXhr = $.ajaxSettings.xhr();
            if (myXhr.upload) {
                showProgress();
                myXhr.upload.addEventListener('progress', function (e) {

                    var time = ((new Date().getTime() - start) / 1000).toFixed(3);
                    if(time == 0){
                        time = 1;
                    }

                    var loaded = e.loaded;                  //已经上传大小情况
                    var total = e.total;                      //附件总大小
                    var percent = Math.floor(100 * loaded / total);     //已经上传的百分比
                    if (percent > 100) {
                        percent = 100;
                    }

                    var now = percent.toFixed(2);

                    $('.progress .progress-speed').html(((e.loaded / 1024) / 1024 / time).toFixed(2) + "M/S, " + ((e.loaded / 1024) / 1024).toFixed(2) + "/" + ((e.total / 1024) / 1024).toFixed(2) + " MB. ");
                    $("#progress_rate").css("width", now + "%");
                    $("#percent").text(now + "%");

                    if (now >= 100) {
                        hideProgress();
                    }

                }, false);
            }
            return myXhr;
        },
    });
}

function uploadPatch() {

    var file = document.getElementById("getF").files[0]; // js 获取文件对象

    var formData = new FormData();

    formData.append("file", file);

    $.ajax({

        url: "/uploadPatch",
        type: 'POST',
        data: formData,
        cache: false,
        contentType: false,
        processData: false,
        enctype: "multipart/form-data",
        async: true,
        timeout: 6000000,

        success: function (result) {
            alert("上传成功")
            // alert(result);

        },

        error: function (request) {
            alert("上传文件失败 ");
            window.location.reload();
        },

        xhr: function () {
            myXhr = $.ajaxSettings.xhr();
            if (myXhr.upload) {
                showProgress();
                myXhr.upload.addEventListener('progress', function (e) {

                    var time = ((new Date().getTime() - start) / 1000).toFixed(3);
                    if(time == 0){
                        time = 1;
                    }

                    var loaded = e.loaded;                  //已经上传大小情况
                    var total = e.total;                      //附件总大小
                    var percent = Math.floor(100 * loaded / total);     //已经上传的百分比
                    if (percent > 100) {
                        percent = 100;
                    }

                    var now = percent.toFixed(2);

                    $('.progress .progress-speed').html(((e.loaded / 1024) / 1024 / time).toFixed(2) + "M/S, " + ((e.loaded / 1024) / 1024).toFixed(2) + "/" + ((e.total / 1024) / 1024).toFixed(2) + " MB. ");
                    $("#progress_rate").css("width", now + "%");
                    $("#percent").text(now + "%");

                    if (now >= 100) {
                        hideProgress();
                    }

                }, false);
            }
            return myXhr;
        },
    });
}


var start = 0;

//显示进度条的函数
function showProgress() {
    start = new Date().getTime();
    $(".progress").css("display", "block");
}
//隐藏进度条的函数
function hideProgress() {
    $('.progress-body .progress-speed').html("0 M/S, 0/0M");
    $('.progress-body percentage').html("0%");
    $(".progress").css("display", "none");

    $(".uploadSuccess").css("display", "block");

}
//进度条更新
function progressHandle(e) {
    $('.progress-body progress').attr({value: e.loaded, max: e.total});
    var percent = e.loaded / e.total * 100;
    var time = ((new Date().getTime() - start) / 1000).toFixed(3);
    if(time == 0){
        time = 1;
    }
    $('.progress-body .progress-speed').html(((e.loaded / 1024) / 1024 / time).toFixed(2) + "M/S, " + ((e.loaded / 1024) / 1024).toFixed(2) + "/" + ((e.total / 1024) / 1024).toFixed(2) + " MB. ");
    $('.progress-body percentage').html(percent.toFixed(2) + "%");
    if (percent == 100) {
        $('.progress-body .progress-info').html("上传完成,后台正在处理...");
    } else {
        $('.progress-body .progress-info').html("文件上传中...");
    }
};
//上传完成处理函数
function completeHandle(e) {
    $('.progress-body .progress-info').html("上传文件完成。");
    setTimeout(hideProgress, 2000);
};

//上传出错处理函数
function failedHandle(e) {
    $('.progress-body .progress-info').html("上传文件出错, 服务不可用或文件过大。");
};
//上传取消处理函数
function canceledHandle(e) {
    $('.progress-body .progress-info').html("上传文件取消。");
};


//提交漏洞表单
function submitFormV() {
    var inputName = document.getElementById("inputName").value;// js 获取文件对象
    var description = document.getElementById("description").value;
    var file = document.getElementById("getF").files[0];

    //alert(inputName);
    //alert(description);

    var formData = new FormData();

    //formData.append("user", "wangjitao");

    formData.append("name", inputName);
    formData.append("description", description);
    formData.append("fileName", file.name);


    $.ajax({

        url: "/submitFormV",
        type: 'POST',
        data: formData,
        cache: false,
        contentType: false,
        processData: false,
        enctype: "multipart/form-data",
        async: true,
        timeout: 6000000,

        success: function (result) {

            alert(result);

        },

        error: function (request) {
            alert("上传文件失败 ");
            window.location.reload();
        }
    });

}

//提交补丁表单
function submitFormP() {

    var inputHash = document.getElementById("inputHash").value;
    var inputName = document.getElementById("inputName").value;// js 获取文件对象
    var description = document.getElementById("description").value;
    var file = document.getElementById("getF").files[0];

    //alert(inputHash);
    //alert(inputName);
    //alert(description);

    var formData = new FormData();

    formData.append("vulnerabilityHash", inputHash);
    formData.append("name", inputName);
    formData.append("description", description);
    formData.append("fileName", file.name);



    $.ajax({

        url: "/submitFormP",
        type: 'POST',
        data: formData,
        cache: false,
        contentType: false,
        processData: false,
        enctype: "multipart/form-data",
        async: true,
        timeout: 6000000,

        success: function (result) {

            alert(result);

        },

        error: function (request) {
            alert("上传文件失败 ");
            window.location.reload();
        }
    });

}

//下载漏洞
function downloadVulnerability(pape) {

    alert(pape);

    var a = document.getElementById("download" + pape);


    a.click();

}

//下载补丁
function downloadPatch(pape) {

    alert(pape);

    var a = document.getElementById("download" + pape);

    a.click();

}
